<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CYBER RPG v7.0 (Fixed)</title>
    
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>

    <script type="module">
        /* 1.1 IMPORT */
        import { MiniKit } from "https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/+esm";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        /* 1.2 WORLD ID (MINIKIT) SETUP */
        const APP_ID = "app_6203a46daf3053d01617ef5293135678";
        MiniKit.install(APP_ID);
        window.MiniKit = MiniKit;
        console.log("[MiniKit] installed");

        /* 1.3 FIREBASE INIT */
        const firebaseConfig = {
            apiKey: "AIzaSyDPxiP-isMK4VOnwRip2RczXOnqxHSyPtk",
            authDomain: "project-chaser-bc0bd.firebaseapp.com",
            projectId: "project-chaser-bc0bd",
            storageBucket: "project-chaser-bc0bd.firebasestorage.app",
            messagingSenderId: "327717972073",
            appId: "1:327717972073:web:49c32d904243569cd7daf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* 1.4 GLOBAL USER ID */
        window.REAL_USER_ID = null;

        /* 1.5 CLOUD SAVE (FIREBASE) */
        window.cloudSave = async function (data) {
            if (!window.REAL_USER_ID) {
                console.warn("[cloudSave] no user id");
                return;
            }
            const loader = document.getElementById("cloud-loader");
            if (loader) loader.style.display = "block";

            try {
                await setDoc(doc(db, "users", window.REAL_USER_ID), data, { merge: true });
                console.log("[cloudSave] success");
            } catch (e) {
                console.error("[cloudSave] error", e);
            } finally {
                if (loader) loader.style.display = "none";
            }
        };

        /* 1.6 CLOUD LOAD (FIREBASE) */
        window.cloudLoad = async function (userId) {
            window.REAL_USER_ID = userId;
            const loader = document.getElementById("cloud-loader");
            if (loader) loader.style.display = "block";

            try {
                const ref = doc(db, "users", userId);
                const snap = await getDoc(ref);

                if (snap.exists()) {
                    console.log("[cloudLoad] data found");
                    if (typeof window.applyGameData === "function") {
                        window.applyGameData(snap.data());
                    }
                } else {
                    console.log("[cloudLoad] new user");
                    if (typeof window.applyGameData === "function") {
                        window.applyGameData(null);
                    }
                }
            } catch (e) {
                console.warn("[cloudLoad] failed", e);
                if (typeof window.applyGameData === "function") {
                    window.applyGameData(null);
                }
            } finally {
                if (loader) loader.style.display = "none";
            }
        };

        /* 1.7 WITHDRAW LOG */
        window.logWithdrawal = async function (coinAmount, wldAmount) {
            if (!window.REAL_USER_ID) return;
            try {
                const playerName = document.getElementById("uiPlayerName")?.innerText.trim() || "UNKNOWN";
                await addDoc(collection(db, "withdrawals"), {
                    userId: window.REAL_USER_ID,
                    name: playerName,
                    coinSpent: coinAmount,
                    wldToReceive: wldAmount,
                    status: "PENDING",
                    createdAt: new Date().toISOString()
                });
                console.log("[withdrawal] logged");
            } catch (e) {
                console.error("[withdrawal] error", e);
            }
        };

        /* 1.8 WALLET ADDRESS */
        window.getWalletAddress = async function () {
            if (!window.MiniKit || !window.MiniKit.isInstalled()) {
                alert("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô World App");
                return null;
            }
            try {
                const nonce = Math.random().toString(36).slice(2);
                const { finalPayload } = await window.MiniKit.commandsAsync.walletAuth({
                    nonce,
                    requestId: "wallet-auth"
                });
                if (finalPayload.status === "success") {
                    console.log("[wallet] address =", finalPayload.address);
                    return finalPayload.address;
                }
            } catch (e) {
                console.error("[wallet] error", e);
            }
            return null;
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;600&family=Orbitron:wght@700;900&display=swap');

        :root {
            --neon-orange: #ff9d00;
            --neon-blue: #00eaff;
            --neon-red: #ff2a2a;
            --bg-dark: #050505;
            --bg-white: #f8f9fa;
            --card-width: 54px;
            --card-height: 76px;
            --gap: 6px;
            --total-width: calc((var(--card-width) * 5) + (var(--gap) * 4));
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: #000;
            font-family: 'Kanit', sans-serif;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .app-container {
            width: 100%; height: 100%; max-width: 480px;
            background-color: var(--bg-dark);
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow: hidden;
        }

        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background-size: cover; background-position: center; }
        .screen.active { display: flex; z-index: 999; }
        .screen-white { background-color: var(--bg-white) !important; color: #333; padding: 20px; overflow-y: auto; background-image: none !important; }

        /* --- BACKGROUNDS --- */
        #screen-login { background-image: url('https://github.com/user-attachments/assets/c9b596d6-88ee-4ca0-bf0a-a80b17ab31f0'); }
        #screen-lobby { background-image: url('https://github.com/user-attachments/assets/70b3047d-bbea-42b8-a8bd-96fe08c69f03'); }

        /* --- UI COMPONENTS --- */
        .white-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 5px; color: #333; }
        .close-btn { font-size: 1.5rem; color: #aaa; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background:rgba(255,255,255,0.1); backdrop-filter:blur(5px); }
        .btn { background: linear-gradient(180deg, var(--neon-orange), #d35400); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer; padding: 10px; width:100%; font-family: 'Kanit'; }
        
        /* ‡∏õ‡∏∏‡πà‡∏° World ID */
        .btn-world-id {
            background: #ffffff; color: #000000; font-family: 'Orbitron'; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 0 20px rgba(255,255,255,0.4); transition: 0.2s;
        }
        .btn-world-id:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255,255,255,0.2); }

        .ad-banner { width: 100%; max-width: 380px; height: 100px; background: #222; margin: 10px auto; border-radius: 8px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; flex-shrink: 0; }
        .ad-banner img { width: 100%; height: 100%; object-fit: cover; }
        .ad-tag { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.6rem; padding: 2px 5px; }

        .video-box { width: 100%; max-width: 380px; height: 100px; margin: 0 auto 20px auto; border: 2px solid var(--neon-blue); box-shadow: 0 0 15px rgba(0, 234, 255, 0.4); background: #000; position: relative; flex-shrink: 0; }
        .video-label { position: absolute; top: 0; left: 0; background: var(--neon-blue); color: #000; font-family: 'Orbitron'; font-size: 0.5rem; font-weight: bold; padding: 2px 6px; z-index: 10; }

        .top-bar { height: 80px; background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent); display: flex; align-items: center; padding: 0 15px; gap: 10px; flex-shrink: 0; color: white; text-shadow: 1px 1px 2px black; justify-content: space-between; }
        .avatar { width: 50px; height: 50px; border: 2px solid var(--neon-orange); border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .lobby-content { flex: 1; overflow-y: auto; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 20px; }
        
        .bottom-nav { height: 70px; background: var(--neon-orange); backdrop-filter: blur(10px); border: 3px solid var(--neon-blue); box-shadow: 0 0 20px rgba(255, 157, 0, 0.4); margin: 0 20px 30px 20px; border-radius: 35px; display: flex; justify-content: center; align-items: center; position: relative; z-index: 100; flex-shrink: 0; animation: pulse 2s infinite; cursor: pointer; }
        .nav-item { text-align: center; color: #000; font-size: 1.8rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-family: 'Orbitron'; width: 100%; text-shadow: 0 0 2px rgba(255,255,255,0.5); }
        
        .marquee-container { background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue); border-radius: 4px; height: 30px; display: flex; align-items: center; overflow: hidden; white-space: nowrap; position: relative; margin: 10px 15px; flex-shrink: 0; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; color: var(--neon-blue); font-size: 0.8rem; font-family: 'Kanit'; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- MONSTER CARD STYLES --- */
        .monster-card { border-radius: 12px; margin-bottom: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.1s; }
        .monster-card:active { transform: scale(0.98); }
        .rank-common { background: linear-gradient(135deg, #2c3e50, #4ca1af); }
        .rank-miniboss { background: linear-gradient(135deg, #1e3c72, #2a5298); border: 1px solid var(--neon-blue); }
        .rank-boss { background: linear-gradient(135deg, #8E0E00, #1F1C18); border: 2px solid #ffd700;} 
        .rank-legendary { background: linear-gradient(135deg, #FFD700, #FF8C00);  border: 2px solid white;  box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);  animation: goldPulse 2s infinite; }
        @keyframes goldPulse { 0% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1); border-color: #fff; } 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } }
        .m-avatar { width: 50px; height: 50px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); object-fit: cover; margin-right: 15px; }
        .m-info h3 { margin: 0; font-family: 'Orbitron'; font-size: 1rem; }
        .hp-badge { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-family: 'Orbitron'; border: 1px solid rgba(255,255,255,0.2); min-width: 60px; text-align: center; }

        /* --- BATTLE & GAMEPLAY --- */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .shaking { animation: shake 0.5s; }
        .battle-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 10px; }
        .game-column { width: var(--total-width); display: flex; flex-direction: column; gap: 6px; }
        .boss-banner { width: 100%; height: 80px; border: 1px solid white; border-radius: 8px; overflow: hidden; background: #000; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .boss-banner img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .boss-banner.hit { border-color: red; animation: shake 0.2s; }
        .hp-wrapper { position: relative; width: 100%; margin: 2px 0; }
        .hp-container { width: 100%; height: 20px; background: #222; border: 1px solid white; border-radius: 4px; overflow: hidden; position: relative; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-enemy { background: linear-gradient(90deg, #ff3333, #aa0000); }
        .hp-player { background: linear-gradient(90deg, #00eaff, #0066cc); }
        .hp-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 12px; line-height: 20px; color: #fff; font-weight: 900; text-shadow: 1px 1px 2px black; font-family: 'Orbitron'; letter-spacing: 1px; }
        .dmg-float { position: absolute; color: #fff; font-weight: 900; font-size: 2.5rem; text-shadow: 2px 2px 0 #ff0000; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; transition: 0.3s; z-index: 50; font-family: 'Orbitron'; pointer-events: none; }
        .dmg-float.show { opacity: 1; transform: translate(-50%, -100%) scale(1); }
        
        /* Cards */
        .card-row { display: flex; gap: var(--gap); justify-content: center; width: 100%; height: 80px; margin-top: 4px; }
        .card-perspective { width: var(--card-width); height: var(--card-height); perspective: 1000px; flex-shrink: 0; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 6px; }
        .card-perspective.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.6rem; border: 1px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .card-front { background-color: #1a1a1a; background-image: url('https://images.unsplash.com/photo-1615818386470-3430ee8b3079?q=80&w=200'); background-size: cover; background-position: center; }
        .card-back { background: linear-gradient(135deg, #eee, #ccc); color: #000; transform: rotateY(180deg); font-weight: 900; }
        .card-perspective.flipped .card-back.enemy-revealed { background: linear-gradient(135deg, var(--neon-red), #990000); color: white; border: 1px solid white; box-shadow: 0 0 10px var(--neon-red); }
        
        .clash-zone { width: var(--total-width); height: 90px; display: flex; gap: var(--gap); justify-content: center; align-items: center; border-top: 1px solid rgba(255,255,255,0.2); border-bottom: 1px solid rgba(255,255,255,0.2); }
        .clash-slot { width: var(--card-width); height: var(--card-height); border: 1px solid rgba(255,255,255,0.4); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: transparent; position: relative; flex-shrink: 0; }
        .clash-slot.active { border: 2px solid #fff; background: rgba(0, 234, 255, 0.15); box-shadow: 0 0 15px rgba(0, 234, 255, 0.3); }
        .clash-slot div { width: 100%; height: 100%; background:var(--neon-blue); color: #000; border-radius: 4px; border: 1px solid white; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; font-weight: 900; }
        
        .my-card { width: var(--card-width); height: var(--card-height); flex-shrink: 0; border: 1px solid white; color: var(--neon-orange); background: #111; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; }
        .my-card.selected { transform: translateY(-12px); background: var(--neon-orange); color: #000; border-color: white; box-shadow: 0 0 15px var(--neon-orange); }
        .my-card.used { opacity: 0; pointer-events: none; }
        
        .main-btn { width: 100%; height: 50px; margin-top: 4px; background: linear-gradient(180deg, var(--neon-blue), #0066cc); border: 1px solid white; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.2rem; color: #fff; font-weight: 900; letter-spacing: 2px; cursor: pointer; box-shadow: 0 4px 0 #004488; transition: 0.1s; text-transform: uppercase; }
        .main-btn:active { transform: translateY(4px); box-shadow: none; }
        .main-btn:disabled { background: #333; color: white; border-color: white; box-shadow: none; cursor: default; }
        .main-btn.attack { background: linear-gradient(180deg, #ff3333, #990000); color: white; box-shadow: 0 4px 0 #550000; }
        .main-btn.sudden { background: yellow; color: black; box-shadow: 0 4px 0 #aaaa00; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes safeWinFlash { 0%, 100% { border-color: white; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); } 50% { border-color: #fff700; box-shadow: 0 0 40px #fff700, inset 0 0 20px #fff700; } }
        .win-pulse { animation: safeWinFlash 0.6s infinite linear !important; z-index: 100; position: relative; }
        .dead-content { filter: brightness(0.4) !important; transition: filter 0.5s ease; }
        
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.92); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .glow-text { animation: textGlow 1.5s infinite alternate; font-family: 'Orbitron'; font-size: 3rem; color:white; }
        @keyframes textGlow { from { text-shadow: 0 0 10px var(--neon-orange); } to { text-shadow: 0 0 30px var(--neon-orange), 0 0 10px white; } }
        
        #cloud-loader { position: fixed; top: 20px; right: 20px; z-index: 10000; display: none; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,234,255,0.3); border-radius: 50%; border-top-color: #00eaff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div id="cloud-loader"><div class="spinner"></div></div>

    <div class="app-container">
        
        <div id="screen-login" class="screen active" style="justify-content: center; align-items: center;">
            <div style="font-family: 'Orbitron'; font-size: 3rem; text-align: center; color:white; text-shadow: 0 0 20px var(--neon-orange); margin-bottom: 20px;">
                PROJECT<br><span style="color:var(--neon-orange)">CHASER</span>
                <div style="font-size: 0.8rem; color:#aaa; margin-top:10px;">V7.0 MINIKIT</div>
            </div>
            
            <button class="btn btn-world-id" style="width: 260px; height: 50px;" id="btnWorldID">
                <span id="btnIcon" style="font-size: 1.5rem;">‚ö´</span> 
                <span id="btnText">VERIFY WITH WORLD ID</span>
            </button>
            <p id="loginStatus" style="color: #666; font-size: 0.8rem; margin-top: 10px; font-family: 'Kanit';">System Ready</p>
        </div>

        <div id="screen-lobby" class="screen">
            <div class="top-bar" style="height: auto; min-height: 80px; padding-top: 5px; padding-bottom: 5px;">
                <div style="display:flex; align-items:center; flex: 1; min-width: 0;">
                    
                    <div class="avatar" style="margin-right: 10px; width: 55px; height: 55px;">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=200">
                    </div>

                    <div style="display: flex; flex-direction: column; justify-content: center; min-width: 0; gap: 2px;">
                        
                        <div style="display:flex; align-items:center; gap: 6px; line-height: 1;">
                            <span id="uiLevel" style="background:var(--neon-blue); color:#000; padding:1px 4px; border-radius:3px; font-size:0.7rem; font-weight:900; font-family:'Orbitron'; flex-shrink: 0;">
                                LV.1
                            </span>
                            <span id="uiPlayerName" onclick="changeName()" style="font-family:'Orbitron'; font-size: 1rem; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight:bold; letter-spacing:1px; cursor: pointer;">
                                PLAYER
                            </span> 
                        </div>

                        <div style="font-size: 0.7rem; white-space: nowrap; color:#ccc; line-height: 1.2;">
                            <span style="color:#ff2a2a; font-weight:bold;">‚ù§ <span id="uiLobbyHP">20/20</span></span>
                            <span style="color:#444; margin: 0 4px;">|</span>
                            <span id="uiExp" style="color:#888;">0/150 XP</span>
                        </div>

                        <div style="font-size: 0.8rem; color:#ffd700; font-weight:bold; line-height: 1;">
                            üü° <span id="uiCoin" style="text-shadow:0 0 5px #ffd700;">0</span> COINS
                        </div>
                    </div>
                </div>

                <div id="btnWallet" style="display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:8px; border:1px solid #444; min-width: 65px; margin-left:5px;">
                    <div style="font-size:1.2rem; filter: drop-shadow(0 0 5px #00eaff); line-height: 1;">üíµ</div>
                </div>
            </div>

            <div class="marquee-container"><div class="marquee-text">üéâ SYSTEM: VERIFIED HUMAN DETECTED! - WELCOME TO PROJECT CHASER üëÅÔ∏è</div></div>
            <div class="ad-banner" onclick="window.open('https://www.youtube.com/watch?v=7YtWwxA9sC4')" style="cursor: pointer;">
                <img src="https://github.com/user-attachments/assets/95431a34-e841-4114-967c-797641a63055">
                <div class="ad-tag">AD</div>
            </div>
            <div class="lobby-content">
                <div class="video-box">
                    <div class="video-label">LIVE FEED</div>
                    <iframe width="100%" height="100%" src="https://www.youtube.com/embed/2ohNHqSTu0w?autoplay=1&loop=1&playlist=2ohNHqSTu0w&mute=1&controls=1&showinfo=0&modestbranding=1" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="bottom-nav" id="btnStartGame">
                <div class="nav-item">START GAME</div>
            </div>
        </div>

        <div id="screen-map" class="screen screen-white">
            <div class="white-header-bar">
                <h2 style="margin:0; font-family:'Orbitron';">MONSTER HUNT</h2>
                <div class="close-btn" id="btnCloseMap">‚úï</div>
            </div>
            <div id="monster-list-container" style="padding-bottom: 80px;"></div>
        </div>

        <div id="screen-battle" class="screen">
            <div class="header" style="height: 50px; background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; padding:0 20px; border-bottom:1px solid #333;">
                <div style="color:white; font-family:'Orbitron'; font-size:1.2rem;">VS <span id="battleEnemyName" style="color:red;">ENEMY</span></div>
            </div>
            <div class="battle-area" id="battleArea">
                <div class="game-column">
                    <div class="boss-banner" id="bossBanner"><img id="bossImg" src="" alt="Boss"></div>
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-enemy" id="enemyHpBar"></div><div class="hp-text" id="enemyHpText">20/20</div></div>
                        <div class="dmg-float" id="eDmgText">-0</div>
                    </div>
                    <div class="card-row" id="enemyCardRow"></div>
                </div>
                <div class="clash-zone" id="clashZone"></div>
                <div class="game-column player-zone">
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-player" id="playerHpBar"></div><div class="hp-text" id="playerHpText">20/20</div></div>
                        <div class="dmg-float" id="pDmgText">-0</div>
                    </div>
                    <div class="card-row" id="playerCardRow"></div>
                    <button id="actionBtn" class="main-btn">SELECT CARDS</button>
                </div>
            </div>
            <div id="resultModal" class="modal">
                <h1 id="resultTitle" class="glow-text">WIN</h1>
                <p id="resultSub" style="color:white;">REWARD: 100 COINS</p>
                <button id="restartBtn" class="main-btn" style="width:220px; margin-top:30px;">CONTINUE</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
// BLOCK 1: GLOBAL STATE + CONFIG
// ‡∏ß‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡πÉ‡∏ô <script>
// =====================================================

// --- Global Player State ---
let playerCOIN = 200;
let playerLevel = 1;
let playerEXP = 0;
let playerMaxHP = 20;
let playerCurrentHP = 20;

let earnedFromGameToday = 0;
let lastRewardDate = new Date().toDateString();
let dailyStamp = [];
let stampStreak = 0;

let currentMonsterType = 'common';

// --- Level / EXP Config ---
const levelConfig = {
  1: { need: 150, bonus: 2 },
  2: { need: 300, bonus: 2 },
  3: { need: 450, bonus: 2 },
  4: { need: 700, bonus: 2 },
  5: { need: 1000, bonus: 2 }
};

const expReward = {
  common: 1,
  miniboss: 2,
  boss: 3,
  legendary: 5
};

// --- Monster Database ---
const monsterDB = [
  { id: 1, name: "Duck Fighter", hp: 20, type: "common", loc: "Sewers", url: "https://images.unsplash.com/photo-1459682687441-7761439a709d?q=80&w=500" },
  { id: 2, name: "Dog Fighter", hp: 20, type: "common", loc: "Sewers", url: "https://github.com/user-attachments/assets/4740cb53-19dd-4186-9c7f-d8af3e3aaddb" },
  { id: 3, name: "Scorpion Fighter", hp: 20, type: "common", loc: "Digital", url: "https://github.com/user-attachments/assets/43953afd-66b6-4ae5-83b9-6121ba7ff05d" },
  { id: 4, name: "Rabbit Fighter", hp: 20, type: "common", loc: "Digital", url: "https://github.com/user-attachments/assets/912e9583-da84-4f1a-adce-e9fe5ae54490" },
  { id: 5, name: "Wolf Fighter", hp: 20, type: "common", loc: "Digital", url: "https://github.com/user-attachments/assets/8e3523b7-7ed7-4d27-b6cf-2f10373738e9" },
  { id: 6, name: "Fire Gobin", hp: 30, type: "miniboss", loc: "Factory", url: "https://github.com/user-attachments/assets/8a354949-f700-4d7e-9ff4-dd5b90164296" },
  { id: 7, name: "THE OVERLORD", hp: 40, type: "boss", loc: "Tower", url: "https://github.com/user-attachments/assets/6dec1453-a3f9-4b8f-8499-ac45bd42da29" },
  { id: 8, name: "GOLDEN DRAGON", hp: 50, type: "legendary", loc: "Sky Realm", url: "https://github.com/user-attachments/assets/b8379da1-b55e-4c8f-bcfb-e68eaae581ed" }
];
        // =====================================================
// BLOCK 2: LOGIN / AUTH (World ID / MiniKit)
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 1
// =====================================================

// ‡∏õ‡∏∏‡πà‡∏° Login ‡∏î‡πâ‡∏ß‡∏¢ World ID
document.getElementById('btnWorldID').onclick = async () => {
  const statusEl = document.getElementById('loginStatus');
  statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";
  statusEl.style.color = "#ff9d00";

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (!window.MiniKit || !MiniKit.isInstalled()) {
    statusEl.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö World App";
    statusEl.style.color = "red";
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏°‡∏ú‡πà‡∏≤‡∏ô World App");
    return;
  }

  try {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á nonce ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö verify
    const nonce = Math.random().toString(36).substring(2, 10);

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å World ID Verify
    const { finalPayload } = await MiniKit.commandsAsync.verify({
      action: 'login',
      signal: nonce,
      verification_level: 'device'
    });

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    if (finalPayload && finalPayload.status === 'success') {
      statusEl.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      statusEl.style.color = "#00ff00";

      // ‡πÉ‡∏ä‡πâ nullifier_hash ‡πÄ‡∏õ‡πá‡∏ô userId
      const userId = finalPayload.nullifier_hash;

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å cloud (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      if (window.cloudLoad) {
        await cloudLoad(userId);
      } else if (window.applyGameData) {
        // fallback ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ cloudLoad
        applyGameData(null);
      }

    } else {
      statusEl.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô";
      statusEl.style.color = "red";
      alert("‚ùå Verify ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

  } catch (err) {
    statusEl.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
    statusEl.style.color = "red";
    alert(err.message || "Login error");
  }
};
       // =====================================================
// BLOCK 3: SAVE / LOAD
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 2
// =====================================================

// -----------------------------------------------------
// SAVE GAME
// -----------------------------------------------------
function saveGame() {
  const nameEl = document.getElementById('uiPlayerName');
  const playerName = nameEl ? nameEl.innerText.trim() : "";

  const saveData = {
    coin: playerCOIN,
    level: playerLevel,
    exp: playerEXP,
    hp: playerCurrentHP,
    name: playerName,

    earnedFromGameToday,
    lastRewardDate,
    dailyStamp,
    stampStreak,

    updatedAt: new Date().toISOString()
  };

  if (window.cloudSave) {
    cloudSave(saveData);
  }
}

// -----------------------------------------------------
// APPLY GAME DATA (LOAD RESULT)
// -----------------------------------------------------
window.applyGameData = function (data) {

  // ---------- LOAD FROM CLOUD ----------
  if (data) {
    playerCOIN = Number(data.coin) || 0;
    playerLevel = Number(data.level) || 1;
    playerEXP = Number(data.exp) || 0;

    // maxHP ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å level (logic ‡πÄ‡∏î‡∏¥‡∏°)
    playerMaxHP = 20 + (playerLevel - 1) * 2;
    playerCurrentHP = Number(data.hp) || playerMaxHP;

    earnedFromGameToday = data.earnedFromGameToday || 0;
    lastRewardDate = data.lastRewardDate || new Date().toDateString();
    dailyStamp = data.dailyStamp || [];
    stampStreak = data.stampStreak || 0;

    if (data.name) {
      const nameEl = document.getElementById('uiPlayerName');
      if (nameEl) nameEl.innerText = data.name.toUpperCase();
    }

  // ---------- NEW PLAYER ----------
  } else {
    playerCOIN = 200;
    playerLevel = 1;
    playerEXP = 0;

    playerMaxHP = 20;
    playerCurrentHP = 20;

    dailyStamp = [new Date().toDateString()];
    stampStreak = 1;

    // reward ‡πÅ‡∏£‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ (logic ‡πÄ‡∏î‡∏¥‡∏°)
    if (typeof giveStampReward === "function") {
      giveStampReward(1);
    }
  }

  // ---------- UPDATE UI ----------
  if (typeof updateBalance === "function") updateBalance();
  if (typeof updateLobbyStats === "function") updateLobbyStats();
  if (typeof initMap === "function") initMap();

  // ---------- GO HOME ----------
  if (typeof nav === "function") nav('home');
};
       // =====================================================
// BLOCK 4: UI / NAVIGATION / AUDIO
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 3
// =====================================================

// -----------------------------------------------------
// UI BUTTON EVENTS
// -----------------------------------------------------

// ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ / Exchange
document.getElementById('btnWallet').onclick = function () {
  gameAlert(
    "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
    "‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢ COINS ‡∏à‡∏∞‡πÉ‡∏ä‡πâ WLD ‡∏à‡∏£‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô World App\n‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å World App ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Ç‡∏∂‡πâ‡∏ô\n‡∏Å‡∏î ACKNOWLEDGE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠",
    function () {
      if (typeof openExchangeModal === "function") {
        openExchangeModal();
      }
    }
  );
};

// ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Map
document.getElementById('btnStartGame').onclick = () => nav('map');

// ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö Lobby
document.getElementById('btnCloseMap').onclick = () => nav('home');

// -----------------------------------------------------
// AUDIO SYSTEM
// -----------------------------------------------------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSfx(type) {
  if (audioCtx.state === 'suspended') audioCtx.resume();

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const now = audioCtx.currentTime;

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  if (type === 'click') {
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(800, now);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
    osc.start(now);
    osc.stop(now + 0.1);

  } else if (type === 'place') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(200, now);
    gain.gain.setValueAtTime(0.5, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.1);
    osc.start(now);
    osc.stop(now + 0.1);

  } else if (type === 'hit') {
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(150, now);
    osc.frequency.exponentialRampToValueAtTime(10, now + 0.4);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.4);
    osc.start(now);
    osc.stop(now + 0.4);

  } else if (type === 'win') {
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(440, now);
    osc.frequency.setValueAtTime(554, now + 0.1);
    osc.frequency.setValueAtTime(659, now + 0.2);
    gain.gain.setValueAtTime(0.9, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.5);
    osc.start(now);
    osc.stop(now + 0.5);
  }
}

// -----------------------------------------------------
// UI UPDATE HELPERS
// -----------------------------------------------------

function updateBalance() {
  const elCoin = document.getElementById('uiCoin');
  if (elCoin) elCoin.innerText = playerCOIN;
}

function updateLobbyStats() {
  const elLevel = document.getElementById('uiLevel');
  const elExp = document.getElementById('uiExp');
  const elHP = document.getElementById('uiLobbyHP');

  if (!levelConfig[playerLevel]) {
    if (elLevel) {
      elLevel.innerText = "LV.MAX";
      elLevel.style.color = "#ffd700";
      elLevel.style.border = "1px solid #ffd700";
    }
    if (elExp) elExp.innerText = "----/---- XP";
  } else {
    if (elLevel) {
      elLevel.innerText = "LV." + playerLevel;
      elLevel.style.color = "#00eaff";
      elLevel.style.border = "none";
    }
    if (elExp) {
      const nextNeed = levelConfig[playerLevel].need;
      elExp.innerText = `${playerEXP}/${nextNeed} XP`;
    }
  }

  if (elHP) elHP.innerText = `${playerCurrentHP}/${playerMaxHP}`;
}

// -----------------------------------------------------
// NAVIGATION
// -----------------------------------------------------
function nav(target) {
  document.querySelectorAll('.screen')
    .forEach(s => s.classList.remove('active'));

  let screenId = 'screen-' + target;
  if (target === 'home') screenId = 'screen-lobby';

  const targetScreen = document.getElementById(screenId);
  if (targetScreen) targetScreen.classList.add('active');

  updateBalance();
  updateLobbyStats();
}
       // =====================================================
// BLOCK 5: MAP & MONSTER
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 4
// =====================================================

// -----------------------------------------------------
// MAP INITIALIZATION
// -----------------------------------------------------
function initMap() {
  const container = document.getElementById('monster-list-container');
  if (!container) return;

  container.innerHTML = '';

  monsterDB.forEach(m => {
    let cardClass = 'rank-common';
    let badgeStyle = '';
    let infoExtra = '';

    if (m.type === 'miniboss') {
      cardClass = 'rank-miniboss';
      badgeStyle = 'color:#00eaff; border-color:#00eaff;';
      infoExtra = '<p style="color:#00eaff; font-size:0.7rem; font-weight:bold;">‚òÖ MINI BOSS</p>';
    } else if (m.type === 'boss') {
      cardClass = 'rank-boss';
      badgeStyle = 'background:#ffd700; color:black; font-weight:bold; border:none;';
      infoExtra = '<p style="color:#ffd700; font-weight:bold; font-size:0.7rem;">‚ò†Ô∏è WORLD BOSS</p>';
    } else if (m.type === 'legendary') {
      cardClass = 'rank-legendary';
      badgeStyle = 'background:white; color:#FF8C00; font-weight:900; border:none; box-shadow: 0 0 10px white;';
      infoExtra = '<p style="color:white; font-weight:900; font-size:0.8rem; text-shadow: 0 1px 2px black;">üëë LEGENDARY BOSS</p>';
    }

    container.innerHTML += `
      <div class="monster-card ${cardClass}" onclick="prepareBattle(${m.id})">
        <div style="display:flex; align-items:center;">
          <img src="${m.url}" class="m-avatar">
          <div class="m-info">
            <h3>${m.name}</h3>
            ${infoExtra}
            <p>${m.loc} ‚Ä¢ HP: ${m.hp}</p>
          </div>
        </div>
        <div class="hp-badge" style="${badgeStyle}">
          HP: ${m.hp}
        </div>
      </div>
    `;
  });
}
       // =====================================================
// BLOCK 6: BATTLE CORE
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 5
// =====================================================

// -----------------------------------------------------
// BATTLE STATE
// -----------------------------------------------------
let battle_enemy = null;

let battle_pHP = 0;
let battle_eHP = 0;
let battle_eMaxHP = 0;

let battle_turn = 0;
let battle_isPlaying = false;

let battle_pDeck = [];
let battle_eDeck = [];

let battle_placedCards = [null, null, null, null, null];

// -----------------------------------------------------
// PREPARE BATTLE (FROM MAP)
// -----------------------------------------------------
window.prepareBattle = function (monsterId) {
  const monster = monsterDB.find(m => m.id === monsterId);
  if (!monster) return;

  battle_enemy = monster;

  battle_eMaxHP = monster.hp;
  battle_eHP = monster.hp;

  battle_pHP = playerCurrentHP;

  initBattleState();
  nav('battle');
};

// -----------------------------------------------------
// INIT BATTLE
// -----------------------------------------------------
function initBattleState() {
  battle_turn = 1;
  battle_isPlaying = true;

  // player deck (logic ‡πÄ‡∏î‡∏¥‡∏°: ‡∏™‡∏∏‡πà‡∏° 5 ‡πÉ‡∏ö)
  battle_pDeck = Array.from({ length: 5 }, () =>
    Math.floor(Math.random() * 5) + 1
  );

  // enemy deck (logic ‡πÄ‡∏î‡∏¥‡∏°: ‡∏™‡∏∏‡πà‡∏° 5 ‡πÉ‡∏ö)
  battle_eDeck = Array.from({ length: 5 }, () =>
    Math.floor(Math.random() * 5) + 1
  );

  battle_placedCards = [null, null, null, null, null];

  updateBattleUI();
}

// -----------------------------------------------------
// PLAYER SELECT CARD
// -----------------------------------------------------
function selectCardAction(value, index) {
  if (!battle_isPlaying) return;
  if (battle_placedCards[index] !== null) return;

  battle_placedCards[index] = value;
  playSfx('place');

  // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö 5 ‡πÉ‡∏ö ‚Üí run battle
  if (battle_placedCards.every(v => v !== null)) {
    runBattleSequence();
  }

  updateBattleUI();
}

// -----------------------------------------------------
// RUN TURN SEQUENCE
// -----------------------------------------------------
async function runBattleSequence() {
  battle_isPlaying = false;

  for (let i = 0; i < 5; i++) {
    const pCard = battle_placedCards[i];
    const eCard = battle_eDeck[i];

    if (pCard > eCard) {
      battle_eHP -= (pCard - eCard);
      flashDamage('enemy', pCard - eCard);
      playSfx('hit');
    } else if (eCard > pCard) {
      battle_pHP -= (eCard - pCard);
      flashDamage('player', eCard - pCard);
      playSfx('hit');
    }

    updateBattleUI();
    await new Promise(r => setTimeout(r, 500));

    if (battle_eHP <= 0 || battle_pHP <= 0) break;
  }

  checkBattleResult();
}

// -----------------------------------------------------
// BATTLE RESULT CHECK
// -----------------------------------------------------
function checkBattleResult() {
  if (battle_eHP <= 0) {
    // WIN
    playSfx('win');

    playerCurrentHP = Math.max(1, battle_pHP);

    battle_isPlaying = false;
    setTimeout(() => {
      handleBattleWin();
    }, 600);

  } else if (battle_pHP <= 0) {
    // LOSE
    playerCurrentHP = 1;

    battle_isPlaying = false;
    setTimeout(() => {
      handleBattleLose();
    }, 600);

  } else {
    // NEXT TURN
    battle_turn++;
    battle_isPlaying = true;

    battle_pDeck = Array.from({ length: 5 }, () =>
      Math.floor(Math.random() * 5) + 1
    );
    battle_eDeck = Array.from({ length: 5 }, () =>
      Math.floor(Math.random() * 5) + 1
    );
    battle_placedCards = [null, null, null, null, null];

    updateBattleUI();
  }
}

// -----------------------------------------------------
// DAMAGE FLASH
// -----------------------------------------------------
function flashDamage(target, amount) {
  const el =
    target === 'enemy'
      ? document.getElementById('enemyHP')
      : document.getElementById('playerHP');

  if (!el) return;

  el.classList.add('flash');
  el.innerText = Math.max(0, el.innerText - amount);

  setTimeout(() => el.classList.remove('flash'), 300);
}

// -----------------------------------------------------
// UPDATE BATTLE UI
// -----------------------------------------------------
function updateBattleUI() {
  const pHpEl = document.getElementById('playerHP');
  const eHpEl = document.getElementById('enemyHP');
  const turnEl = document.getElementById('battleTurn');

  if (pHpEl) pHpEl.innerText = Math.max(0, battle_pHP);
  if (eHpEl) eHpEl.innerText = Math.max(0, battle_eHP);
  if (turnEl) turnEl.innerText = "TURN " + battle_turn;

  // render player cards
  battle_pDeck.forEach((v, i) => {
    const el = document.getElementById('pCard' + i);
    if (el) {
      el.innerText = v;
      el.onclick = () => selectCardAction(v, i);
    }
  });

  // render enemy cards (hidden)
  battle_eDeck.forEach((_, i) => {
    const el = document.getElementById('eCard' + i);
    if (el) el.innerText = "?";
  });
}
       // =====================================================
// BLOCK 7: BATTLE RESULT / REWARD / EXP / SAVE
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 6
// =====================================================

const BASE_HP = 20;
const MAX_DAILY_LIMIT = 500;

// -----------------------------------------------------
// HANDLE BATTLE WIN
// -----------------------------------------------------
function handleBattleWin() {
  let rewardCoin = calculateBattleReward();
  let gainedEXP = expReward[battle_enemy.type] || 1;

  // ---- Daily Limit ----
  const today = new Date().toDateString();
  if (gameState.lastRewardDate !== today) {
    gameState.lastRewardDate = today;
    gameState.earnedToday = 0;
  }

  let actualReward = rewardCoin;
  if (gameState.earnedToday + rewardCoin > MAX_DAILY_LIMIT) {
    actualReward = Math.max(0, MAX_DAILY_LIMIT - gameState.earnedToday);
    gameAlert(
      "‡∏•‡∏¥‡∏°‡∏¥‡∏ï‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•",
      `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö COINS ‡∏Ñ‡∏£‡∏ö‡∏•‡∏¥‡∏°‡∏¥‡∏ï‡πÅ‡∏•‡πâ‡∏ß<br>‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° ${actualReward} COINS`
    );
  }

  gameState.coin += actualReward;
  gameState.earnedToday += actualReward;

  // ---- EXP / LEVEL ----
  gameState.exp += gainedEXP;
  checkLevelUp(cfg => {
    gameAlert(
      "LEVEL UP!",
      `‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô ${gameState.level}<br>Max HP +${cfg.bonus}`
    );
  });

  // ---- HP ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö ----
  if (!gameState.isSuddenDeath) {
    gameState.hp = gameState.maxHP;
  }

  // ---- Reset Battle Flag ----
  gameState.inBattle = false;
  gameState.currentMonsterType = null;

  saveGame();

  // ---- Result UI ----
  showResultModal({
    title: "VICTORY",
    color: "#ff9d00",
    text: `
      +${actualReward} COINS<br>
      +${gainedEXP} EXP
    `,
    btnText: "CONTINUE",
    onClose: () => nav('map')
  });
}

// -----------------------------------------------------
// HANDLE BATTLE LOSE
// -----------------------------------------------------
function handleBattleLose() {
  let penalty;

  if (battle_eHP >= battle_eMaxHP / 2) {
    penalty = gameState.maxHP;
  } else {
    penalty = Math.floor(gameState.maxHP / 2);
  }

  gameState.coin = Math.max(0, gameState.coin - penalty);

  // ---- Sudden Death Lose ----
  if (gameState.isSuddenDeath) {
    exitSuddenDeath();
  }

  gameState.hp = gameState.maxHP;
  gameState.inBattle = false;

  saveGame();

  showResultModal({
    title: "DEFEATED",
    color: "red",
    text: `‡πÄ‡∏™‡∏µ‡∏¢ ${penalty} COINS`,
    btnText: "BACK TO MAP",
    onClose: () => nav('map')
  });
}

// -----------------------------------------------------
// DOUBLE KO ‚Üí SUDDEN DEATH
// -----------------------------------------------------
function enterSuddenDeath(enemyHP = 10) {
  gameState.isSuddenDeath = true;
  gameState.maxHP = 10;
  gameState.hp = 10;

  battle_eMaxHP = enemyHP;
  battle_eHP = enemyHP;

  saveGame();

  showResultModal({
    title: "DOUBLE KO",
    color: "yellow",
    text: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î SUDDEN DEATH<br>HP = 10",
    btnText: "FIGHT!",
    onClose: () => {
      initBattleState();
      nav('battle');
    }
  });
}

function exitSuddenDeath() {
  gameState.isSuddenDeath = false;
  gameState.maxHP = BASE_HP + (gameState.level - 1) * 2;
  gameState.hp = gameState.maxHP;
}

// -----------------------------------------------------
// CALCULATE REWARD
// -----------------------------------------------------
function calculateBattleReward() {
  const damageTaken = gameState.maxHP - battle_pHP;
  let reward = battle_eMaxHP - damageTaken;
  return Math.max(0, reward);
}

// -----------------------------------------------------
// LEVEL UP CHECK
// -----------------------------------------------------
function checkLevelUp(onLevelUp) {
  const cfg = levelConfig[gameState.level];
  if (!cfg) return;

  if (gameState.exp >= cfg.need) {
    gameState.exp -= cfg.need;
    gameState.level++;
    gameState.maxHP += cfg.bonus;

    if (!gameState.isSuddenDeath) {
      gameState.hp = gameState.maxHP;
    }

    if (onLevelUp) onLevelUp(cfg);
  }
}

// -----------------------------------------------------
// RESULT MODAL
// -----------------------------------------------------
function showResultModal({ title, color, text, btnText, onClose }) {
  const modal = document.getElementById('resultModal');
  const titleEl = document.getElementById('resultTitle');
  const subEl = document.getElementById('resultSub');
  const btnEl = document.getElementById('restartBtn');

  titleEl.innerText = title;
  titleEl.style.color = color;
  subEl.innerHTML = text;

  btnEl.innerText = btnText;
  btnEl.onclick = () => {
    modal.style.display = 'none';
    if (onClose) onClose();
  };

  modal.style.display = 'flex';
}
       // =====================================================
// BLOCK 8: DAILY REWARD / STAMP / ALERT / NAME
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 7
// =====================================================

// -----------------------------------------------------
// DAILY STAMP REWARD
// -----------------------------------------------------
function processDailyStamp() {
  const today = new Date().toDateString();

  if (gameState.lastStampDate === today) return;

  gameState.lastStampDate = today;
  gameState.stampStreak = (gameState.stampStreak || 0) + 1;

  let reward = 0;
  let msg = "";

  switch (gameState.stampStreak) {
    case 1: reward = 1; msg = "‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å +1 COIN"; break;
    case 2: reward = 1; msg = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 +1 COIN"; break;
    case 3: reward = 2; msg = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3 +2 COINS"; break;
    case 4: reward = 2; msg = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4 +2 COINS"; break;
    case 5: reward = 3; msg = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 +3 COINS"; break;
    case 6: reward = 3; msg = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 6 +3 COINS"; break;
    case 7:
      reward = 8;
      msg = "‡∏Ñ‡∏£‡∏ö 7 ‡∏ß‡∏±‡∏ô! ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +8 COINS";
      gameState.stampStreak = 0;
      break;
    default:
      gameState.stampStreak = 1;
      reward = 1;
      msg = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà +1 COIN";
  }

  gameState.coin += reward;
  saveGame();

  gameAlert("DAILY REWARD", msg);
}

// -----------------------------------------------------
// GENERIC GAME ALERT
// -----------------------------------------------------
function gameAlert(title, message, callback = null) {
  const old = document.getElementById('customAlert');
  if (old) old.remove();

  const overlay = document.createElement('div');
  overlay.id = 'customAlert';
  overlay.style.cssText = `
    position:fixed; inset:0;
    background:rgba(0,0,0,0.85);
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  const box = document.createElement('div');
  box.style.cssText = `
    background:#111;
    border:2px solid #ff0000;
    padding:20px;
    width:80%;
    max-width:360px;
    border-radius:10px;
    text-align:center;
    font-family:'Kanit',sans-serif;
  `;

  box.innerHTML = `
    <h2 style="color:#ff0000;margin-bottom:10px;">${title}</h2>
    <p style="color:#ddd;font-size:0.9rem;">${message}</p>
    <button id="alertOkBtn" class="main-btn" style="margin-top:15px;">OK</button>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById('alertOkBtn').onclick = () => {
    overlay.remove();
    if (typeof callback === 'function') callback();
  };
}

// -----------------------------------------------------
// CHANGE PLAYER NAME
// -----------------------------------------------------
function openChangeNameModal() {
  const old = document.getElementById('nameModal');
  if (old) old.remove();

  const overlay = document.createElement('div');
  overlay.id = 'nameModal';
  overlay.style.cssText = `
    position:fixed; inset:0;
    background:rgba(0,0,0,0.9);
    z-index:10000;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  const box = document.createElement('div');
  box.style.cssText = `
    background:#111;
    border:2px solid #00eaff;
    padding:20px;
    width:85%;
    max-width:320px;
    border-radius:12px;
    text-align:center;
    font-family:'Kanit',sans-serif;
  `;

  box.innerHTML = `
    <h3 style="color:#00eaff;">SET YOUR NAME</h3>
    <input id="nameInput" maxlength="8"
      style="width:100%;margin:15px 0;padding:10px;
      background:#000;color:#fff;text-align:center;
      font-size:1.2rem;border:1px solid #444;"
      placeholder="NAME (MAX 8)">
    <button id="confirmNameBtn" class="main-btn">CONFIRM</button>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById('confirmNameBtn').onclick = () => {
    const val = document.getElementById('nameInput').value.trim();
    if (!val) return;

    const regex = /^[A-Za-z0-9‡∏Å-‡πô]+$/;
    if (!regex.test(val)) {
      gameAlert("ERROR", "‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ");
      return;
    }

    gameState.name = val.toUpperCase();
    document.getElementById('uiPlayerName').innerText = gameState.name;
    saveGame();
    overlay.remove();
  };
}
       // =====================================================
// BLOCK 9: EXCHANGE / BUY / SELL (WORLD APP)
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 8
// =====================================================

const EXCHANGE_RATE_BUY = 1000;   // 1 WLD = 1000 COINS
const EXCHANGE_RATE_SELL = 1100;  // 1100 COINS = 1 WLD

// -----------------------------------------------------
// OPEN EXCHANGE MODAL
// -----------------------------------------------------
function openExchangeModal() {
  const old = document.getElementById('exchangeModal');
  if (old) old.remove();

  const overlay = document.createElement('div');
  overlay.id = 'exchangeModal';
  overlay.style.cssText = `
    position:fixed; inset:0;
    background:rgba(0,0,0,0.9);
    z-index:10000;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  const box = document.createElement('div');
  box.style.cssText = `
    background:#111;
    border:1px solid #00eaff;
    width:90%;
    max-width:400px;
    padding:20px;
    border-radius:12px;
    font-family:'Kanit',sans-serif;
    position:relative;
  `;

  box.innerHTML = `
    <div style="position:absolute;top:10px;right:15px;cursor:pointer;color:#666"
      onclick="document.getElementById('exchangeModal').remove()">‚úï</div>

    <h2 style="color:#00eaff;text-align:center;">EXCHANGE</h2>

    <div style="display:flex;margin:15px 0;">
      <button id="tabBuy" style="flex:1">BUY</button>
      <button id="tabSell" style="flex:1">SELL</button>
    </div>

    <div id="panelBuy">
      <p style="color:#aaa;font-size:0.8rem;text-align:center;">
        RATE: 1 WLD = ${EXCHANGE_RATE_BUY} COINS
      </p>
      <input id="inpBuyWLD" type="number" step="0.1" value="0.1"
        style="width:100%;padding:10px;text-align:center;">
      <p style="text-align:center;margin:10px 0;">
        ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b id="txtBuyCoin">100</b> COINS
      </p>
      <button id="btnConfirmBuy" class="main-btn">CONFIRM BUY</button>
    </div>

    <div id="panelSell" style="display:none;">
      <p style="color:#aaa;font-size:0.8rem;text-align:center;">
        RATE: ${EXCHANGE_RATE_SELL} COINS = 1 WLD
      </p>
      <input id="inpSellCoin" type="number" value="110"
        style="width:100%;padding:10px;text-align:center;">
      <p style="text-align:center;margin:10px 0;">
        ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b id="txtSellWLD">0.10</b> WLD
      </p>
      <button id="btnConfirmSell" class="main-btn">CONFIRM SELL</button>
    </div>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  // ---- TAB SWITCH ----
  const tabBuy = box.querySelector('#tabBuy');
  const tabSell = box.querySelector('#tabSell');
  const panelBuy = box.querySelector('#panelBuy');
  const panelSell = box.querySelector('#panelSell');

  tabBuy.onclick = () => {
    panelBuy.style.display = 'block';
    panelSell.style.display = 'none';
  };
  tabSell.onclick = () => {
    panelBuy.style.display = 'none';
    panelSell.style.display = 'block';
  };

  // ---- BUY INPUT ----
  const inpBuy = box.querySelector('#inpBuyWLD');
  const txtBuyCoin = box.querySelector('#txtBuyCoin');
  inpBuy.oninput = () => {
    const val = parseFloat(inpBuy.value) || 0;
    txtBuyCoin.innerText = Math.floor(val * EXCHANGE_RATE_BUY);
  };

  // ---- SELL INPUT ----
  const inpSell = box.querySelector('#inpSellCoin');
  const txtSellWLD = box.querySelector('#txtSellWLD');
  inpSell.oninput = () => {
    const val = parseInt(inpSell.value) || 0;
    txtSellWLD.innerText = (val / EXCHANGE_RATE_SELL).toFixed(2);
  };

  // ---- CONFIRM BUY ----
  box.querySelector('#btnConfirmBuy').onclick = async () => {
    const amountWLD = parseFloat(inpBuy.value) || 0;
    if (amountWLD < 0.1) {
      gameAlert("ERROR", "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 0.1 WLD");
      return;
    }

    if (!window.MiniKit || !MiniKit.isInstalled()) {
      gameAlert("ERROR", "‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");
      return;
    }

    const coins = Math.floor(amountWLD * EXCHANGE_RATE_BUY);

    try {
      const wei = BigInt(Math.floor(amountWLD * 1e6)) * 1000000000000n;

      const { finalPayload } = await MiniKit.commandsAsync.pay({
        reference: "buy_" + Date.now(),
        to: "0x205e9c33961d56f35f7308efc771bb10fda9ec7f",
        tokens: [{ symbol: "WLD", token_amount: wei.toString() }],
        description: `Buy ${coins} COINS`
      });

      if (finalPayload.status === 'success') {
        gameState.coin += coins;
        saveGame();
        updateBalance();
        overlay.remove();
        gameAlert("SUCCESS", `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${coins} COINS`);
      } else {
        gameAlert("FAILED", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");
      }
    } catch (e) {
      gameAlert("ERROR", e.message);
    }
  };

  // ---- CONFIRM SELL ----
  box.querySelector('#btnConfirmSell').onclick = async () => {
    const amountCoin = parseInt(inpSell.value) || 0;
    if (amountCoin < EXCHANGE_RATE_SELL) {
      gameAlert("ERROR", "COINS ‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥");
      return;
    }
    if (amountCoin > gameState.coin) {
      gameAlert("ERROR", "COINS ‡πÑ‡∏°‡πà‡∏û‡∏≠");
      return;
    }

    gameAlert("INFO", "‡∏Å‡∏≤‡∏£ SELL ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô Server + Smart Contract");
  };
}
   </script>
</body>
</html>
