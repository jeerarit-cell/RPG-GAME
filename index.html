<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CYBER RPG v7.0 (Fixed)</title>
    
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>

    <script type="module">
        /* 1.1 IMPORT */
        import { MiniKit } from "https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/+esm";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        /* 1.2 WORLD ID (MINIKIT) SETUP */
        const APP_ID = "app_6203a46daf3053d01617ef5293135678";
        MiniKit.install(APP_ID);
        window.MiniKit = MiniKit;
        console.log("[MiniKit] installed");

        /* 1.3 FIREBASE INIT */
        const firebaseConfig = {
            apiKey: "AIzaSyDPxiP-isMK4VOnwRip2RczXOnqxHSyPtk",
            authDomain: "project-chaser-bc0bd.firebaseapp.com",
            projectId: "project-chaser-bc0bd",
            storageBucket: "project-chaser-bc0bd.firebasestorage.app",
            messagingSenderId: "327717972073",
            appId: "1:327717972073:web:49c32d904243569cd7daf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* 1.4 GLOBAL USER ID */
        window.REAL_USER_ID = null;

        /* 1.5 CLOUD SAVE (FIREBASE) */
        window.cloudSave = async function (data) {
            if (!window.REAL_USER_ID) {
                console.warn("[cloudSave] no user id");
                return;
            }
            const loader = document.getElementById("cloud-loader");
            if (loader) loader.style.display = "block";

            try {
                await setDoc(doc(db, "users", window.REAL_USER_ID), data, { merge: true });
                console.log("[cloudSave] success");
            } catch (e) {
                console.error("[cloudSave] error", e);
            } finally {
                if (loader) loader.style.display = "none";
            }
        };

        /* 1.6 CLOUD LOAD (FIREBASE) */
        window.cloudLoad = async function (userId) {
            window.REAL_USER_ID = userId;
            const loader = document.getElementById("cloud-loader");
            if (loader) loader.style.display = "block";

            try {
                const ref = doc(db, "users", userId);
                const snap = await getDoc(ref);

                if (snap.exists()) {
                    console.log("[cloudLoad] data found");
                    if (typeof window.applyGameData === "function") {
                        window.applyGameData(snap.data());
                    }
                } else {
                    console.log("[cloudLoad] new user");
                    if (typeof window.applyGameData === "function") {
                        window.applyGameData(null);
                    }
                }
            } catch (e) {
                console.warn("[cloudLoad] failed", e);
                if (typeof window.applyGameData === "function") {
                    window.applyGameData(null);
                }
            } finally {
                if (loader) loader.style.display = "none";
            }
        };

        /* 1.7 WITHDRAW LOG */
        window.logWithdrawal = async function (coinAmount, wldAmount) {
            if (!window.REAL_USER_ID) return;
            try {
                const playerName = document.getElementById("uiPlayerName")?.innerText.trim() || "UNKNOWN";
                await addDoc(collection(db, "withdrawals"), {
                    userId: window.REAL_USER_ID,
                    name: playerName,
                    coinSpent: coinAmount,
                    wldToReceive: wldAmount,
                    status: "PENDING",
                    createdAt: new Date().toISOString()
                });
                console.log("[withdrawal] logged");
            } catch (e) {
                console.error("[withdrawal] error", e);
            }
        };

        /* 1.8 WALLET ADDRESS */
        window.getWalletAddress = async function () {
            if (!window.MiniKit || !window.MiniKit.isInstalled()) {
                alert("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô World App");
                return null;
            }
            try {
                const nonce = Math.random().toString(36).slice(2);
                const { finalPayload } = await window.MiniKit.commandsAsync.walletAuth({
                    nonce,
                    requestId: "wallet-auth"
                });
                if (finalPayload.status === "success") {
                    console.log("[wallet] address =", finalPayload.address);
                    return finalPayload.address;
                }
            } catch (e) {
                console.error("[wallet] error", e);
            }
            return null;
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;600&family=Orbitron:wght@700;900&display=swap');

        :root {
            --neon-orange: #ff9d00;
            --neon-blue: #00eaff;
            --neon-red: #ff2a2a;
            --bg-dark: #050505;
            --bg-white: #f8f9fa;
            --card-width: 54px;
            --card-height: 76px;
            --gap: 6px;
            --total-width: calc((var(--card-width) * 5) + (var(--gap) * 4));
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: #000;
            font-family: 'Kanit', sans-serif;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .app-container {
            width: 100%; height: 100%; max-width: 480px;
            background-color: var(--bg-dark);
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow: hidden;
        }

        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background-size: cover; background-position: center; }
        .screen.active { display: flex; z-index: 999; }
        .screen-white { background-color: var(--bg-white) !important; color: #333; padding: 20px; overflow-y: auto; background-image: none !important; }

        /* --- BACKGROUNDS --- */
        #screen-login { background-image: url('https://github.com/user-attachments/assets/c9b596d6-88ee-4ca0-bf0a-a80b17ab31f0'); }
        #screen-lobby { background-image: url('https://github.com/user-attachments/assets/70b3047d-bbea-42b8-a8bd-96fe08c69f03'); }

        /* --- UI COMPONENTS --- */
        .white-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 5px; color: #333; }
        .close-btn { font-size: 1.5rem; color: #aaa; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background:rgba(255,255,255,0.1); backdrop-filter:blur(5px); }
        .btn { background: linear-gradient(180deg, var(--neon-orange), #d35400); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer; padding: 10px; width:100%; font-family: 'Kanit'; }
        
        /* ‡∏õ‡∏∏‡πà‡∏° World ID */
        .btn-world-id {
            background: #ffffff; color: #000000; font-family: 'Orbitron'; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 0 20px rgba(255,255,255,0.4); transition: 0.2s;
        }
        .btn-world-id:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255,255,255,0.2); }

        .ad-banner { width: 100%; max-width: 380px; height: 100px; background: #222; margin: 10px auto; border-radius: 8px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; flex-shrink: 0; }
        .ad-banner img { width: 100%; height: 100%; object-fit: cover; }
        .ad-tag { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.6rem; padding: 2px 5px; }

        .video-box { width: 100%; max-width: 380px; height: 100px; margin: 0 auto 20px auto; border: 2px solid var(--neon-blue); box-shadow: 0 0 15px rgba(0, 234, 255, 0.4); background: #000; position: relative; flex-shrink: 0; }
        .video-label { position: absolute; top: 0; left: 0; background: var(--neon-blue); color: #000; font-family: 'Orbitron'; font-size: 0.5rem; font-weight: bold; padding: 2px 6px; z-index: 10; }

        .top-bar { height: 80px; background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent); display: flex; align-items: center; padding: 0 15px; gap: 10px; flex-shrink: 0; color: white; text-shadow: 1px 1px 2px black; justify-content: space-between; }
        .avatar { width: 50px; height: 50px; border: 2px solid var(--neon-orange); border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .lobby-content { flex: 1; overflow-y: auto; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 20px; }
        
        .bottom-nav { height: 70px; background: var(--neon-orange); backdrop-filter: blur(10px); border: 3px solid var(--neon-blue); box-shadow: 0 0 20px rgba(255, 157, 0, 0.4); margin: 0 20px 30px 20px; border-radius: 35px; display: flex; justify-content: center; align-items: center; position: relative; z-index: 100; flex-shrink: 0; animation: pulse 2s infinite; cursor: pointer; }
        .nav-item { text-align: center; color: #000; font-size: 1.8rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-family: 'Orbitron'; width: 100%; text-shadow: 0 0 2px rgba(255,255,255,0.5); }
        
        .marquee-container { background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue); border-radius: 4px; height: 30px; display: flex; align-items: center; overflow: hidden; white-space: nowrap; position: relative; margin: 10px 15px; flex-shrink: 0; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; color: var(--neon-blue); font-size: 0.8rem; font-family: 'Kanit'; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- MONSTER CARD STYLES --- */
        .monster-card { border-radius: 12px; margin-bottom: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.1s; }
        .monster-card:active { transform: scale(0.98); }
        .rank-common { background: linear-gradient(135deg, #2c3e50, #4ca1af); }
        .rank-miniboss { background: linear-gradient(135deg, #1e3c72, #2a5298); border: 1px solid var(--neon-blue); }
        .rank-boss { background: linear-gradient(135deg, #8E0E00, #1F1C18); border: 2px solid #ffd700;} 
        .rank-legendary { background: linear-gradient(135deg, #FFD700, #FF8C00);  border: 2px solid white;  box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);  animation: goldPulse 2s infinite; }
        @keyframes goldPulse { 0% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1); border-color: #fff; } 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } }
        .m-avatar { width: 50px; height: 50px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); object-fit: cover; margin-right: 15px; }
        .m-info h3 { margin: 0; font-family: 'Orbitron'; font-size: 1rem; }
        .hp-badge { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-family: 'Orbitron'; border: 1px solid rgba(255,255,255,0.2); min-width: 60px; text-align: center; }

        /* --- BATTLE & GAMEPLAY --- */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .shaking { animation: shake 0.5s; }
        .battle-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 10px; }
        .game-column { width: var(--total-width); display: flex; flex-direction: column; gap: 6px; }
        .boss-banner { width: 100%; height: 80px; border: 1px solid white; border-radius: 8px; overflow: hidden; background: #000; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .boss-banner img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .boss-banner.hit { border-color: red; animation: shake 0.2s; }
        .hp-wrapper { position: relative; width: 100%; margin: 2px 0; }
        .hp-container { width: 100%; height: 20px; background: #222; border: 1px solid white; border-radius: 4px; overflow: hidden; position: relative; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-enemy { background: linear-gradient(90deg, #ff3333, #aa0000); }
        .hp-player { background: linear-gradient(90deg, #00eaff, #0066cc); }
        .hp-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 12px; line-height: 20px; color: #fff; font-weight: 900; text-shadow: 1px 1px 2px black; font-family: 'Orbitron'; letter-spacing: 1px; }
        .dmg-float { position: absolute; color: #fff; font-weight: 900; font-size: 2.5rem; text-shadow: 2px 2px 0 #ff0000; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; transition: 0.3s; z-index: 50; font-family: 'Orbitron'; pointer-events: none; }
        .dmg-float.show { opacity: 1; transform: translate(-50%, -100%) scale(1); }
        
        /* Cards */
        .card-row { display: flex; gap: var(--gap); justify-content: center; width: 100%; height: 80px; margin-top: 4px; }
        .card-perspective { width: var(--card-width); height: var(--card-height); perspective: 1000px; flex-shrink: 0; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 6px; }
        .card-perspective.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.6rem; border: 1px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .card-front { background-color: #1a1a1a; background-image: url('https://images.unsplash.com/photo-1615818386470-3430ee8b3079?q=80&w=200'); background-size: cover; background-position: center; }
        .card-back { background: linear-gradient(135deg, #eee, #ccc); color: #000; transform: rotateY(180deg); font-weight: 900; }
        .card-perspective.flipped .card-back.enemy-revealed { background: linear-gradient(135deg, var(--neon-red), #990000); color: white; border: 1px solid white; box-shadow: 0 0 10px var(--neon-red); }
        
        .clash-zone { width: var(--total-width); height: 90px; display: flex; gap: var(--gap); justify-content: center; align-items: center; border-top: 1px solid rgba(255,255,255,0.2); border-bottom: 1px solid rgba(255,255,255,0.2); }
        .clash-slot { width: var(--card-width); height: var(--card-height); border: 1px solid rgba(255,255,255,0.4); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: transparent; position: relative; flex-shrink: 0; }
        .clash-slot.active { border: 2px solid #fff; background: rgba(0, 234, 255, 0.15); box-shadow: 0 0 15px rgba(0, 234, 255, 0.3); }
        .clash-slot div { width: 100%; height: 100%; background:var(--neon-blue); color: #000; border-radius: 4px; border: 1px solid white; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; font-weight: 900; }
        
        .my-card { width: var(--card-width); height: var(--card-height); flex-shrink: 0; border: 1px solid white; color: var(--neon-orange); background: #111; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; }
        .my-card.selected { transform: translateY(-12px); background: var(--neon-orange); color: #000; border-color: white; box-shadow: 0 0 15px var(--neon-orange); }
        .my-card.used { opacity: 0; pointer-events: none; }
        
        .main-btn { width: 100%; height: 50px; margin-top: 4px; background: linear-gradient(180deg, var(--neon-blue), #0066cc); border: 1px solid white; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.2rem; color: #fff; font-weight: 900; letter-spacing: 2px; cursor: pointer; box-shadow: 0 4px 0 #004488; transition: 0.1s; text-transform: uppercase; }
        .main-btn:active { transform: translateY(4px); box-shadow: none; }
        .main-btn:disabled { background: #333; color: white; border-color: white; box-shadow: none; cursor: default; }
        .main-btn.attack { background: linear-gradient(180deg, #ff3333, #990000); color: white; box-shadow: 0 4px 0 #550000; }
        .main-btn.sudden { background: yellow; color: black; box-shadow: 0 4px 0 #aaaa00; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes safeWinFlash { 0%, 100% { border-color: white; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); } 50% { border-color: #fff700; box-shadow: 0 0 40px #fff700, inset 0 0 20px #fff700; } }
        .win-pulse { animation: safeWinFlash 0.6s infinite linear !important; z-index: 100; position: relative; }
        .dead-content { filter: brightness(0.4) !important; transition: filter 0.5s ease; }
        
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.92); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .glow-text { animation: textGlow 1.5s infinite alternate; font-family: 'Orbitron'; font-size: 3rem; color:white; }
        @keyframes textGlow { from { text-shadow: 0 0 10px var(--neon-orange); } to { text-shadow: 0 0 30px var(--neon-orange), 0 0 10px white; } }
        
        #cloud-loader { position: fixed; top: 20px; right: 20px; z-index: 10000; display: none; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,234,255,0.3); border-radius: 50%; border-top-color: #00eaff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div id="cloud-loader"><div class="spinner"></div></div>

    <div class="app-container">
        
        <div id="screen-login" class="screen active" style="justify-content: center; align-items: center;">
            <div style="font-family: 'Orbitron'; font-size: 3rem; text-align: center; color:white; text-shadow: 0 0 20px var(--neon-orange); margin-bottom: 20px;">
                PROJECT<br><span style="color:var(--neon-orange)">CHASER</span>
                <div style="font-size: 0.8rem; color:#aaa; margin-top:10px;">V7.0 MINIKIT</div>
            </div>
            
            <button class="btn btn-world-id" style="width: 260px; height: 50px;" id="btnWorldID">
                <span id="btnIcon" style="font-size: 1.5rem;">‚ö´</span> 
                <span id="btnText">VERIFY WITH WORLD ID</span>
            </button>
            <p id="loginStatus" style="color: #666; font-size: 0.8rem; margin-top: 10px; font-family: 'Kanit';">System Ready</p>
        </div>

        <div id="screen-lobby" class="screen">
            <div class="top-bar" style="height: auto; min-height: 80px; padding-top: 5px; padding-bottom: 5px;">
                <div style="display:flex; align-items:center; flex: 1; min-width: 0;">
                    
                    <div class="avatar" style="margin-right: 10px; width: 55px; height: 55px;">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=200">
                    </div>

                    <div style="display: flex; flex-direction: column; justify-content: center; min-width: 0; gap: 2px;">
                        
                        <div style="display:flex; align-items:center; gap: 6px; line-height: 1;">
                            <span id="uiLevel" style="background:var(--neon-blue); color:#000; padding:1px 4px; border-radius:3px; font-size:0.7rem; font-weight:900; font-family:'Orbitron'; flex-shrink: 0;">
                                LV.1
                            </span>
                            <span id="uiPlayerName" onclick="changeName()" style="font-family:'Orbitron'; font-size: 1rem; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight:bold; letter-spacing:1px; cursor: pointer;">
                                PLAYER
                            </span> 
                        </div>

                        <div style="font-size: 0.7rem; white-space: nowrap; color:#ccc; line-height: 1.2;">
                            <span style="color:#ff2a2a; font-weight:bold;">‚ù§ <span id="uiLobbyHP">20/20</span></span>
                            <span style="color:#444; margin: 0 4px;">|</span>
                            <span id="uiExp" style="color:#888;">0/150 XP</span>
                        </div>

                        <div style="font-size: 0.8rem; color:#ffd700; font-weight:bold; line-height: 1;">
                            üü° <span id="uiCoin" style="text-shadow:0 0 5px #ffd700;">0</span> COINS
                        </div>
                    </div>
                </div>

                <div id="btnWallet" style="display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:8px; border:1px solid #444; min-width: 65px; margin-left:5px;">
                    <div style="font-size:1.2rem; filter: drop-shadow(0 0 5px #00eaff); line-height: 1;">üíµ</div>
                </div>
            </div>

            <div class="marquee-container"><div class="marquee-text">üéâ SYSTEM: VERIFIED HUMAN DETECTED! - WELCOME TO PROJECT CHASER üëÅÔ∏è</div></div>
            <div class="ad-banner" onclick="window.open('https://www.youtube.com/watch?v=7YtWwxA9sC4')" style="cursor: pointer;">
                <img src="https://github.com/user-attachments/assets/95431a34-e841-4114-967c-797641a63055">
                <div class="ad-tag">AD</div>
            </div>
            <div class="lobby-content">
                <div class="video-box">
                    <div class="video-label">LIVE FEED</div>
                    <iframe width="100%" height="100%" src="https://www.youtube.com/embed/2ohNHqSTu0w?autoplay=1&loop=1&playlist=2ohNHqSTu0w&mute=1&controls=1&showinfo=0&modestbranding=1" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="bottom-nav" id="btnStartGame">
                <div class="nav-item">START GAME</div>
            </div>
        </div>

        <div id="screen-map" class="screen screen-white">
            <div class="white-header-bar">
                <h2 style="margin:0; font-family:'Orbitron';">MONSTER HUNT</h2>
                <div class="close-btn" id="btnCloseMap">‚úï</div>
            </div>
            <div id="monster-list-container" style="padding-bottom: 80px;"></div>
        </div>

        <div id="screen-battle" class="screen">
            <div class="header" style="height: 50px; background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; padding:0 20px; border-bottom:1px solid #333;">
                <div style="color:white; font-family:'Orbitron'; font-size:1.2rem;">VS <span id="battleEnemyName" style="color:red;">ENEMY</span></div>
            </div>
            <div class="battle-area" id="battleArea">
                <div class="game-column">
                    <div class="boss-banner" id="bossBanner"><img id="bossImg" src="" alt="Boss"></div>
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-enemy" id="enemyHpBar"></div><div class="hp-text" id="enemyHpText">20/20</div></div>
                        <div class="dmg-float" id="eDmgText">-0</div>
                    </div>
                    <div class="card-row" id="enemyCardRow"></div>
                </div>
                <div class="clash-zone" id="clashZone"></div>
                <div class="game-column player-zone">
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-player" id="playerHpBar"></div><div class="hp-text" id="playerHpText">20/20</div></div>
                        <div class="dmg-float" id="pDmgText">-0</div>
                    </div>
                    <div class="card-row" id="playerCardRow"></div>
                    <button id="actionBtn" class="main-btn">SELECT CARDS</button>
                </div>
            </div>
            <div id="resultModal" class="modal">
                <h1 id="resultTitle" class="glow-text">WIN</h1>
                <p id="resultSub" style="color:white;">REWARD: 100 COINS</p>
                <button id="restartBtn" class="main-btn" style="width:220px; margin-top:30px;">CONTINUE</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
// BLOCK 1: GLOBAL STATE + CONFIG
// ‡∏ß‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡πÉ‡∏ô <script>
// =====================================================

// --- Global Player State ---
let playerCOIN = 200;
let playerLevel = 1;
let playerEXP = 0;
let playerMaxHP = 20;
let playerCurrentHP = 20;

let earnedFromGameToday = 0;
let lastRewardDate = new Date().toDateString();
let dailyStamp = [];
let stampStreak = 0;

let currentMonsterType = 'common';

// --- Level / EXP Config ---
const levelConfig = {
  1: { need: 150, bonus: 2 },
  2: { need: 300, bonus: 2 },
  3: { need: 450, bonus: 2 },
  4: { need: 700, bonus: 2 },
  5: { need: 1000, bonus: 2 }
};

const expReward = {
  common: 1,
  miniboss: 2,
  boss: 3,
  legendary: 5
};

// --- Monster Database ---
const monsterDB = [
  { id: 1, name: "Duck Fighter", hp: 20, type: "common", loc: "Sewers", url: "https://images.unsplash.com/photo-1459682687441-7761439a709d?q=80&w=500" },
  { id: 2, name: "Dog Fighter", hp: 20, type: "common", loc: "Sewers", url: "https://github.com/user-attachments/assets/4740cb53-19dd-4186-9c7f-d8af3e3aaddb" },
  { id: 3, name: "Scorpion Fighter", hp: 20, type: "common", loc: "Digital", url: "https://github.com/user-attachments/assets/43953afd-66b6-4ae5-83b9-6121ba7ff05d" },
  { id: 4, name: "Rabbit Fighter", hp: 20, type: "common", loc: "Digital", url: "https://github.com/user-attachments/assets/912e9583-da84-4f1a-adce-e9fe5ae54490" },
  { id: 5, name: "Wolf Fighter", hp: 20, type: "common", loc: "Digital", url: "https://github.com/user-attachments/assets/8e3523b7-7ed7-4d27-b6cf-2f10373738e9" },
  { id: 6, name: "Fire Gobin", hp: 30, type: "miniboss", loc: "Factory", url: "https://github.com/user-attachments/assets/8a354949-f700-4d7e-9ff4-dd5b90164296" },
  { id: 7, name: "THE OVERLORD", hp: 40, type: "boss", loc: "Tower", url: "https://github.com/user-attachments/assets/6dec1453-a3f9-4b8f-8499-ac45bd42da29" },
  { id: 8, name: "GOLDEN DRAGON", hp: 50, type: "legendary", loc: "Sky Realm", url: "https://github.com/user-attachments/assets/b8379da1-b55e-4c8f-bcfb-e68eaae581ed" }
];
        // ========================================================
// BLOCK 2 : LOGIN / WORLD ID (CONNECT TO SAVE SYSTEM)
// ========================================================

// ---------- LOGIN STATE ----------
let LOGIN_STATE = "idle"; // idle | loading | success | error
window.currentUserId = null;

// ---------- UI HELPER ----------
function setLoginStatus(text, color) {
    const el = document.getElementById('loginStatus');
    if (!el) return;
    el.innerText = text;
    el.style.color = color;
}

// ---------- MAIN LOGIN ----------
async function loginWithWorldID() {
    // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥ / ‡∏Å‡∏±‡∏ô login ‡∏ã‡πâ‡∏≠‡∏ô
    if (LOGIN_STATE === "loading" || LOGIN_STATE === "success") return;

    LOGIN_STATE = "loading";
    setLoginStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...", "#ff9d00");

    // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if (!window.MiniKit || !window.MiniKit.isInstalled()) {
        LOGIN_STATE = "error";
        setLoginStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App", "red");
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏°‡∏ú‡πà‡∏≤‡∏ô World App");
        return;
    }

    try {
        // nonce ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö verify
        const nonce = Math.random().toString(36).substring(2, 10);

        const { finalPayload } = await MiniKit.commandsAsync.verify({
            action: 'login',
            signal: nonce,
            verification_level: 'device'
        });

        if (!finalPayload || finalPayload.status !== 'success') {
            throw new Error("Verify failed");
        }

        // ---------- LOGIN SUCCESS ----------
        window.currentUserId = finalPayload.nullifier_hash;
        LOGIN_STATE = "success";

        setLoginStatus("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "#00ff00");

        // ---------- LOAD GAME DATA ----------
        // BLOCK 3 ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        if (typeof cloudLoad === "function") {
            await cloudLoad(window.currentUserId);
        } else {
            console.warn("cloudLoad not found");
            if (typeof applyGameData === "function") {
                applyGameData(null);
            }
        }

    } catch (err) {
        console.error("Login error:", err);
        LOGIN_STATE = "error";
        setLoginStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "red");
        alert(err.message || "Login error");
    }
}

// ---------- BUTTON BIND ----------
(function bindLoginButton() {
    const btn = document.getElementById('btnWorldID');
    if (!btn) {
        console.warn("btnWorldID not found");
        return;
    }

    btn.onclick = () => {
        if (LOGIN_STATE !== "loading") {
            loginWithWorldID();
        }
    };
})();
       // ========================================================
// BLOCK 3 : CORE SAVE / LOAD SYSTEM
// ========================================================

// ---------- CONFIG ----------
const SAVE_VERSION = 1;

// ---------- UTIL ----------
function deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
}

// ---------- SCHEMA ----------
function getDefaultGameState() {
    return {
        version: SAVE_VERSION,

        coin: 200,
        level: 1,
        exp: 0,

        hp: 20,
        maxHP: 20,

        inBattle: false,
        isSuddenDeath: false,

        earnedToday: 0,
        lastRewardDate: new Date().toDateString(),
        dailyStamp: [],
        stampStreak: 0,

        currentMonsterType: 'common'
    };
}

// ---------- EXPORT DATA ----------
function getGameData() {
    return deepClone(window.gameState);
}

// ---------- APPLY DATA (ONE WAY IN) ----------
window.applyGameData = function (data) {
    const base = getDefaultGameState();
    const incoming = data || {};

    // merge schema (‡∏Å‡∏±‡∏ô field ‡∏´‡∏≤‡∏¢ / ‡πÄ‡∏Å‡πà‡∏≤)
    window.gameState = Object.assign(base, incoming);

    // safety clamp
    if (gameState.hp > gameState.maxHP) {
        gameState.hp = gameState.maxHP;
    }
    if (gameState.hp < 0) {
        gameState.hp = 0;
    }

    // UI update (‡∏Å‡∏•‡∏≤‡∏á)
    if (typeof updateLobbyStats === 'function') updateLobbyStats();
    if (typeof updateBalance === 'function') updateBalance();
};

// ---------- CLOUD LOAD ----------
window.cloudLoad = async function (userId) {
    if (!userId) {
        console.warn("cloudLoad: missing userId");
        applyGameData(null);
        return;
    }

    try {
        // üëâ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ú‡∏π‡∏Å Firebase / backend ‡∏à‡∏£‡∏¥‡∏á
        const savedData = await firebaseLoad(userId); // ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô object ‡∏´‡∏£‡∏∑‡∏≠ null

        if (savedData) {
            applyGameData(savedData);
        } else {
            applyGameData(null);
            await cloudSave(getGameData(), userId);
        }
    } catch (err) {
        console.error("cloudLoad error:", err);
        applyGameData(null);
    }
};

// ---------- CLOUD SAVE ----------
window.cloudSave = async function (data, userId = window.currentUserId) {
    if (!userId || !data) {
        console.warn("cloudSave skipped");
        return;
    }

    try {
        await firebaseSave(userId, deepClone(data));
    } catch (err) {
        console.error("cloudSave error:", err);
    }
};

// ---------- SAFE SAVE ----------
window.saveGame = function () {
    if (window.cloudSave) {
        cloudSave(getGameData());
    }
};
       // =====================================================
// BLOCK 4: UI / NAVIGATION / AUDIO
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 3
// =====================================================

// -----------------------------------------------------
// UI BUTTON EVENTS
// -----------------------------------------------------

// ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ / Exchange
document.getElementById('btnWallet').onclick = function () {
  gameAlert(
    "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
    "‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢ COINS ‡∏à‡∏∞‡πÉ‡∏ä‡πâ WLD ‡∏à‡∏£‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô World App\n‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å World App ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Ç‡∏∂‡πâ‡∏ô\n‡∏Å‡∏î ACKNOWLEDGE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠",
    function () {
      if (typeof openExchangeModal === "function") {
        openExchangeModal();
      }
    }
  );
};

// ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Map
document.getElementById('btnStartGame').onclick = () => nav('map');

// ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö Lobby
document.getElementById('btnCloseMap').onclick = () => nav('home');

// -----------------------------------------------------
// AUDIO SYSTEM
// -----------------------------------------------------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSfx(type) {
  if (audioCtx.state === 'suspended') audioCtx.resume();

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const now = audioCtx.currentTime;

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  if (type === 'click') {
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(800, now);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
    osc.start(now);
    osc.stop(now + 0.1);

  } else if (type === 'place') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(200, now);
    gain.gain.setValueAtTime(0.5, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.1);
    osc.start(now);
    osc.stop(now + 0.1);

  } else if (type === 'hit') {
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(150, now);
    osc.frequency.exponentialRampToValueAtTime(10, now + 0.4);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.4);
    osc.start(now);
    osc.stop(now + 0.4);

  } else if (type === 'win') {
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(440, now);
    osc.frequency.setValueAtTime(554, now + 0.1);
    osc.frequency.setValueAtTime(659, now + 0.2);
    gain.gain.setValueAtTime(0.9, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.5);
    osc.start(now);
    osc.stop(now + 0.5);
  }
}

// -----------------------------------------------------
// UI UPDATE HELPERS
// -----------------------------------------------------

function updateBalance() {
  const elCoin = document.getElementById('uiCoin');
  if (elCoin) elCoin.innerText = playerCOIN;
}

function updateLobbyStats() {
  const elLevel = document.getElementById('uiLevel');
  const elExp = document.getElementById('uiExp');
  const elHP = document.getElementById('uiLobbyHP');

  if (!levelConfig[playerLevel]) {
    if (elLevel) {
      elLevel.innerText = "LV.MAX";
      elLevel.style.color = "#ffd700";
      elLevel.style.border = "1px solid #ffd700";
    }
    if (elExp) elExp.innerText = "----/---- XP";
  } else {
    if (elLevel) {
      elLevel.innerText = "LV." + playerLevel;
      elLevel.style.color = "#00eaff";
      elLevel.style.border = "none";
    }
    if (elExp) {
      const nextNeed = levelConfig[playerLevel].need;
      elExp.innerText = `${playerEXP}/${nextNeed} XP`;
    }
  }

  if (elHP) elHP.innerText = `${playerCurrentHP}/${playerMaxHP}`;
}

// -----------------------------------------------------
// NAVIGATION
// -----------------------------------------------------
function nav(target) {
  document.querySelectorAll('.screen')
    .forEach(s => s.classList.remove('active'));

  let screenId = 'screen-' + target;
  if (target === 'home') screenId = 'screen-lobby';

  const targetScreen = document.getElementById(screenId);
  if (targetScreen) targetScreen.classList.add('active');

  updateBalance();
  updateLobbyStats();
}
       // =====================================================
// BLOCK 5: MAP & MONSTER
// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å BLOCK 4
// =====================================================

// -----------------------------------------------------
// MAP INITIALIZATION
// -----------------------------------------------------
function initMap() {
  const container = document.getElementById('monster-list-container');
  if (!container) return;

  container.innerHTML = '';

  monsterDB.forEach(m => {
    let cardClass = 'rank-common';
    let badgeStyle = '';
    let infoExtra = '';

    if (m.type === 'miniboss') {
      cardClass = 'rank-miniboss';
      badgeStyle = 'color:#00eaff; border-color:#00eaff;';
      infoExtra = '<p style="color:#00eaff; font-size:0.7rem; font-weight:bold;">‚òÖ MINI BOSS</p>';
    } else if (m.type === 'boss') {
      cardClass = 'rank-boss';
      badgeStyle = 'background:#ffd700; color:black; font-weight:bold; border:none;';
      infoExtra = '<p style="color:#ffd700; font-weight:bold; font-size:0.7rem;">‚ò†Ô∏è WORLD BOSS</p>';
    } else if (m.type === 'legendary') {
      cardClass = 'rank-legendary';
      badgeStyle = 'background:white; color:#FF8C00; font-weight:900; border:none; box-shadow: 0 0 10px white;';
      infoExtra = '<p style="color:white; font-weight:900; font-size:0.8rem; text-shadow: 0 1px 2px black;">üëë LEGENDARY BOSS</p>';
    }

    container.innerHTML += `
      <div class="monster-card ${cardClass}" onclick="prepareBattle(${m.id})">
        <div style="display:flex; align-items:center;">
          <img src="${m.url}" class="m-avatar">
          <div class="m-info">
            <h3>${m.name}</h3>
            ${infoExtra}
            <p>${m.loc} ‚Ä¢ HP: ${m.hp}</p>
          </div>
        </div>
        <div class="hp-badge" style="${badgeStyle}">
          HP: ${m.hp}
        </div>
      </div>
    `;
  });
}
       // ========================================================
// BLOCK 6 : BATTLE CORE + inBattle / DISCONNECT / FORFEIT
// ========================================================

// ---------- BATTLE STATE (TRANSIENT ONLY) ----------
let battle_eMaxHP = 20;
let battle_eHP = 20;

let battle_pDeck = [];
let battle_eDeck = [];
let battle_placedCards = [null, null, null, null, null];

let battle_turn = 0;
let battle_isPlaying = false;

// ---------- PREPARE BATTLE ----------
window.prepareBattle = function (monsterID) {
    // ‡∏ï‡πâ‡∏≠‡∏á login ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß
    if (typeof LOGIN_STATE !== "undefined" && LOGIN_STATE !== "success") {
        gameAlert("ERROR", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    const monster = monsterDB.find(m => m.id === monsterID);
    if (!monster) return;

    // ‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (logic ‡πÄ‡∏î‡∏¥‡∏°)
    if (playerCOIN < playerMaxHP) {
        gameAlert(
            "ACCESS DENIED",
            `‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠! <br>‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô <b style="color:#ff0000">${playerMaxHP} COINS</b>`
        );
        playSfx('click');
        return;
    }

    // ----- SET GAME STATE -----
    gameState.inBattle = true;
    gameState.currentMonsterType = monster.type;

    // ‡πÑ‡∏°‡πà heal ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô sudden death
    if (!gameState.isSuddenDeath) {
        playerCurrentHP = playerMaxHP;
        gameState.hp = playerCurrentHP;
    }

    // ----- SET BATTLE STATE -----
    battle_eMaxHP = monster.hp;
    battle_eHP = monster.hp;

    // ----- UI -----
    document.getElementById('battleEnemyName').innerText = monster.name;
    document.getElementById('bossImg').src = monster.url;
    document.getElementById('screen-battle').style.backgroundImage =
        "url('https://github.com/user-attachments/assets/13b147e2-f363-49ce-bd43-68530d231a60')";

    nav('battle');
    initBattleState();
};

// ---------- INIT BATTLE ----------
function initBattleState() {
    battle_turn = 0;
    battle_isPlaying = false;
    battle_placedCards = [null, null, null, null, null];

    document.getElementById('resultModal').style.display = 'none';

    // ----- CLASH ZONE -----
    const cZone = document.getElementById('clashZone');
    cZone.innerHTML = '';
    for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = i === 0 ? 'clash-slot active' : 'clash-slot';
        slot.dataset.id = i;
        cZone.appendChild(slot);
    }

    // ----- ENEMY DECK -----
    const eRow = document.getElementById('enemyCardRow');
    eRow.innerHTML = '';
    battle_eDeck = [1, 2, 3, 4, 5].sort(() => Math.random() - 0.5);

    const enemyImg = document.getElementById('bossImg').src;
    for (let i = 0; i < 5; i++) {
        const wrap = document.createElement('div');
        wrap.className = 'card-perspective';
        wrap.id = `eWrap${i}`;
        wrap.innerHTML = `
            <div class="card-inner">
                <div class="card-front"
                     style="background-image:url('${enemyImg}');
                            background-size:cover;
                            background-position:center;">
                </div>
                <div class="card-back enemy-revealed" id="eCard${i}">?</div>
            </div>`;
        eRow.appendChild(wrap);
    }

    // ----- PLAYER DECK -----
    const pRow = document.getElementById('playerCardRow');
    pRow.innerHTML = '';
    battle_pDeck = [1, 2, 3, 4, 5].sort(() => Math.random() - 0.5);

    battle_pDeck.forEach(val => {
        const card = document.createElement('div');
        card.className = 'my-card';
        card.textContent = val;
        card.onclick = () => selectCardAction(val, card);
        pRow.appendChild(card);
    });

    // ----- ACTION BUTTON -----
    const btn = document.getElementById('actionBtn');
    btn.textContent = "SELECT CARDS";
    btn.disabled = true;
    btn.className = 'main-btn';
    btn.onclick = null;

    updateBattleUI();
    playSfx('place');
}

// ---------- PLAYER SELECT CARD ----------
function selectCardAction(val, el) {
    if (battle_isPlaying) return;
    if (battle_turn >= 5) return;
    if (el.classList.contains('used')) return;

    battle_placedCards[battle_turn] = val;
    el.classList.add('used');

    const slot = document.querySelector(
        `.clash-slot[data-id="${battle_turn}"]`
    );
    slot.innerHTML = `<div>${val}</div>`;
    slot.classList.remove('active');

    battle_turn++;

    if (battle_turn < 5) {
        document
            .querySelector(`.clash-slot[data-id="${battle_turn}"]`)
            .classList.add('active');
    } else {
        const btn = document.getElementById('actionBtn');
        btn.textContent = "ATTACK !!!";
        btn.disabled = false;
        btn.classList.add('attack');
        btn.onclick = runBattleSequence;
    }

    playSfx('click');
}

// ---------- RUN BATTLE ----------
async function runBattleSequence() {
    battle_isPlaying = true;
    document.getElementById('actionBtn').disabled = true;

    let pSurvivors = [];
    let eSurvivors = [];

    for (let i = 0; i < 5; i++) {
        const pVal = battle_placedCards[i];
        const eVal = battle_eDeck[i];

        const eWrap = document.getElementById(`eWrap${i}`);
        const eBack = document.getElementById(`eCard${i}`);
        eBack.textContent = eVal;
        eWrap.classList.add('flipped');

        await new Promise(r => setTimeout(r, 600));

        const pSlot = document.querySelector(
            `.clash-slot[data-id="${i}"]`
        );
        const pCard = pSlot.querySelector('div');

        if (pVal > eVal) {
            eBack.classList.add('dead-content');
            pCard.parentElement.classList.add('win-pulse');
            pSurvivors.push(pVal);
        } else if (eVal > pVal) {
            pCard.classList.add('dead-content');
            eBack.classList.add('win-pulse');
            eSurvivors.push(eVal);
        } else {
            eBack.classList.add('dead-content');
            pCard.classList.add('dead-content');
        }

        playSfx('hit');
        await new Promise(r => setTimeout(r, 400));
    }

    // ----- DAMAGE CALC -----
    let dmgToEnemy = 0;
    let dmgToPlayer = 0;

    if (pSurvivors.length > eSurvivors.length) {
        dmgToEnemy = pSurvivors.reduce((a, b) => a + b, 0);
    } else if (eSurvivors.length > pSurvivors.length) {
        dmgToPlayer = eSurvivors.reduce((a, b) => a + b, 0);
    } else {
        dmgToEnemy = pSurvivors.reduce((a, b) => a + b, 0);
        dmgToPlayer = eSurvivors.reduce((a, b) => a + b, 0);
    }

    battle_eHP -= dmgToEnemy;
    playerCurrentHP -= dmgToPlayer;

    if (playerCurrentHP < 0) playerCurrentHP = 0;

    updateBattleUI();

    await new Promise(r => setTimeout(r, 1200));

    // ----- DELEGATE RESULT -----
    // BLOCK 7 ‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô
    if (typeof handleBattleResult === "function") {
        handleBattleResult({
            enemyHP: battle_eHP,
            enemyMaxHP: battle_eMaxHP,
            playerHP: playerCurrentHP
        });
    }
}

// ---------- UPDATE BATTLE UI ----------
function updateBattleUI() {
    if (battle_eHP < 0) battle_eHP = 0;

    document.getElementById('enemyHpBar').style.width =
        (battle_eHP / battle_eMaxHP) * 100 + "%";
    document.getElementById('enemyHpText').innerText =
        `${battle_eHP}/${battle_eMaxHP}`;

    document.getElementById('playerHpBar').style.width =
        (playerCurrentHP / playerMaxHP) * 100 + "%";
    document.getElementById('playerHpText').innerText =
        `${playerCurrentHP}/${playerMaxHP}`;
}

// ---------- DISCONNECT / FORFEIT SAFETY ----------
window.addEventListener("beforeunload", () => {
    if (gameState.inBattle) {
        gameState.hp = 0;
        gameState.inBattle = false;

        if (navigator.sendBeacon && typeof cloudSave === "function") {
            navigator.sendBeacon(
                "/saveGame",
                JSON.stringify({
                    userId: window.currentUserId,
                    gameState: getGameData()
                })
            );
        }
    }
});

document.addEventListener("visibilitychange", () => {
    if (
        document.visibilityState === "hidden" &&
        gameState.inBattle
    ) {
        saveGame();
    }
});
       // ========================================================
// BLOCK 7 : BATTLE RESULT / REWARD / PENALTY / SAVE
// ========================================================

// ---------- MAIN ENTRY FROM BLOCK 6 ----------
window.handleBattleResult = function ({ enemyHP, enemyMaxHP, playerHP }) {

    // ---------- ENEMY DEFEATED ----------
    if (enemyHP <= 0 && playerHP > 0) {
        applyVictory();
        return;
    }

    // ---------- PLAYER DEFEATED ----------
    if (playerHP <= 0) {
        applyDefeat();
        return;
    }

    // ---------- BOTH STILL ALIVE ----------
    continueBattle();
};

// ---------- VICTORY ----------
function applyVictory() {
    gameState.inBattle = false;

    const rewardCoin = calculateBattleReward();

    playerCOIN += rewardCoin;
    gameState.coin = playerCOIN;

    // Sudden Death ‡πÑ‡∏°‡πà heal
    if (!gameState.isSuddenDeath) {
        playerCurrentHP = playerMaxHP;
        gameState.hp = playerCurrentHP;
    } else {
        gameState.hp = playerCurrentHP;
    }

    showBattleResultModal({
        title: "VICTORY!",
        message: `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b style="color:#00ff00">${rewardCoin} COINS</b>`
    });

    saveGame();
}

// ---------- DEFEAT ----------
function applyDefeat() {
    gameState.inBattle = false;

    // ‡πÅ‡∏û‡πâ = HP 0 ‡πÄ‡∏™‡∏°‡∏≠
    playerCurrentHP = 0;
    gameState.hp = 0;

    // Sudden Death = ‡∏•‡∏á‡πÇ‡∏ó‡∏©‡∏´‡∏ô‡∏±‡∏Å
    if (gameState.isSuddenDeath) {
        const penalty = Math.min(playerCOIN, playerMaxHP);
        playerCOIN -= penalty;
        gameState.coin = playerCOIN;

        showBattleResultModal({
            title: "DEFEATED",
            message: `Sudden Death!<br>‡πÄ‡∏™‡∏µ‡∏¢ <b style="color:#ff0000">${penalty} COINS</b>`
        });
    } else {
        showBattleResultModal({
            title: "DEFEATED",
            message: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ"
        });
    }

    saveGame();
}

// ---------- CONTINUE ----------
function continueBattle() {
    showBattleResultModal({
        title: "NEXT ROUND",
        message: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"
    });

    // ‡πÑ‡∏°‡πà save ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    // battle ‡∏à‡∏∞ reset ‡∏ú‡πà‡∏≤‡∏ô BLOCK 6
}

// ---------- REWARD CALC ----------
function calculateBattleReward() {
    let base = 10;

    if (gameState.currentMonsterType === "boss") {
        base = 25;
    }

    if (gameState.isSuddenDeath) {
        base = Math.floor(base * 1.5);
    }

    return base;
}

// ---------- RESULT MODAL ----------
function showBattleResultModal({ title, message }) {
    const modal = document.getElementById('resultModal');
    const titleEl = document.getElementById('resultTitle');
    const msgEl = document.getElementById('resultMessage');

    titleEl.innerHTML = title;
    msgEl.innerHTML = message;

    modal.style.display = 'flex';

    const btn = document.getElementById('resultBtn');
    btn.onclick = () => {
        modal.style.display = 'none';
        nav('home');
    };
}
       // ========================================================
// BLOCK 8 : DAILY REWARD / PLAYER NAME / ONE-TIME SAVE
// ========================================================

// ---------- DAILY REWARD ----------
window.checkDailyReward = function () {
    if (!gameState) return;

    const today = new Date().toISOString().slice(0, 10);

    if (gameState.lastDailyReward === today) return;

    const rewardCoin = 30;

    playerCOIN += rewardCoin;
    gameState.coin = playerCOIN;
    gameState.lastDailyReward = today;

    showDailyRewardModal(rewardCoin);

    saveGame(); // ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ã‡∏ü‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
};

// ---------- DAILY MODAL ----------
function showDailyRewardModal(amount) {
    const modal = document.getElementById('dailyModal');
    const text = document.getElementById('dailyText');

    text.innerHTML = `üéÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b style="color:#00ff00">${amount} COINS</b>`;
    modal.style.display = 'flex';

    document.getElementById('dailyBtn').onclick = () => {
        modal.style.display = 'none';
    };
}

// ---------- PLAYER NAME ----------
window.setPlayerName = function (name) {
    if (!name || name.trim().length < 3) {
        gameAlert("ERROR", "‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£");
        return;
    }

    gameState.playerName = name.trim();

    saveGame(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ = save
};

// ---------- ONE-TIME GRANT (FUTURE SAFE) ----------
window.grantOnce = function (key, rewardFn) {
    if (!gameState.oneTimeFlags) {
        gameState.oneTimeFlags = {};
    }

    if (gameState.oneTimeFlags[key]) return;

    rewardFn();

    gameState.oneTimeFlags[key] = true;

    saveGame();
};
       // ========================================================
// BLOCK 9 : COIN ‚Üî WLD EXCHANGE (REAL MONEY ONLY)
// ========================================================

// ---------- CONFIG ----------
const EXCHANGE_RATE_BUY  = 1000; // 1 WLD = 1000 COINS
const EXCHANGE_RATE_SELL = 1100; // 1100 COINS = 1 WLD
const MIN_BUY_WLD  = 0.1;
const MIN_SELL_COIN = 110;

// ========================================================
// OPEN EXCHANGE MODAL
// ========================================================
window.openExchangeModal = function () {
    const old = document.getElementById('exchangeModal');
    if (old) old.remove();

    const overlay = document.createElement('div');
    overlay.id = 'exchangeModal';
    overlay.style.cssText = `
        position:fixed; inset:0; background:rgba(0,0,0,.9);
        display:flex; align-items:center; justify-content:center;
        z-index:10000;
    `;

    const box = document.createElement('div');
    box.style.cssText = `
        background:#111; border:1px solid #00eaff;
        width:90%; max-width:400px; padding:20px;
        border-radius:12px; font-family:'Kanit';
    `;

    box.innerHTML = `
        <div style="text-align:right; cursor:pointer; color:#666"
             onclick="document.getElementById('exchangeModal').remove()">‚úï</div>

        <h2 style="color:#00eaff; text-align:center;">EXCHANGE</h2>

        <div style="display:flex; margin-bottom:10px;">
            <div id="tabBuy"  style="flex:1; text-align:center; color:#00eaff; cursor:pointer; border-bottom:2px solid #00eaff;">BUY</div>
            <div id="tabSell" style="flex:1; text-align:center; color:#666; cursor:pointer;">SELL</div>
        </div>

        <!-- BUY -->
        <div id="panelBuy">
            <p style="color:#aaa; text-align:center;">1 WLD = ${EXCHANGE_RATE_BUY} COINS</p>
            <input id="buyWLD" type="number" step="0.1" value="0.1"
                   style="width:100%; padding:10px; text-align:center;">
            <p style="text-align:center; margin:10px 0;">
                ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b id="buyCoin">${Math.floor(MIN_BUY_WLD * EXCHANGE_RATE_BUY)}</b> COINS
            </p>
            <button class="main-btn" onclick="confirmBuy()">CONFIRM BUY</button>
        </div>

        <!-- SELL -->
        <div id="panelSell" style="display:none;">
            <p style="color:#aaa; text-align:center;">${EXCHANGE_RATE_SELL} COINS = 1 WLD</p>
            <input id="sellCoin" type="number" step="10" value="${MIN_SELL_COIN}"
                   style="width:100%; padding:10px; text-align:center;">
            <p style="text-align:center; margin:10px 0;">
                ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b id="sellWLD">${(MIN_SELL_COIN / EXCHANGE_RATE_SELL).toFixed(2)}</b> WLD
            </p>
            <button class="main-btn" onclick="confirmSell()">CONFIRM SELL</button>
        </div>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // ----- TAB -----
    document.getElementById('tabBuy').onclick = () => {
        panelBuy.style.display = 'block';
        panelSell.style.display = 'none';
        tabBuy.style.color = '#00eaff';
        tabSell.style.color = '#666';
        tabBuy.style.borderBottom = '2px solid #00eaff';
        tabSell.style.borderBottom = 'none';
    };

    document.getElementById('tabSell').onclick = () => {
        panelBuy.style.display = 'none';
        panelSell.style.display = 'block';
        tabSell.style.color = '#00eaff';
        tabBuy.style.color = '#666';
        tabSell.style.borderBottom = '2px solid #00eaff';
        tabBuy.style.borderBottom = 'none';
    };

    // ----- LIVE CALC -----
    buyWLD.oninput = () => {
        const v = parseFloat(buyWLD.value) || 0;
        buyCoin.innerText = Math.floor(v * EXCHANGE_RATE_BUY);
    };

    sellCoin.oninput = () => {
        const v = parseInt(sellCoin.value) || 0;
        sellWLD.innerText = (v / EXCHANGE_RATE_SELL).toFixed(2);
    };
};

// ========================================================
// BUY : WLD ‚Üí COINS
// ========================================================
async function confirmBuy() {
    const wld = parseFloat(document.getElementById('buyWLD').value) || 0;
    if (wld < MIN_BUY_WLD) {
        gameAlert("ERROR", `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${MIN_BUY_WLD} WLD`);
        return;
    }

    if (!window.MiniKit || !MiniKit.isInstalled()) {
        gameAlert("ERROR", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");
        return;
    }

    const coinGain = Math.floor(wld * EXCHANGE_RATE_BUY);

    try {
        const wei = BigInt(Math.floor(wld * 1e6)) * 1000000000000n;

        const { finalPayload } = await MiniKit.commandsAsync.pay({
            reference: "buy_" + Date.now(),
            to: "0x205e9c33961d56f35f7308efc771bb10fda9ec7f",
            tokens: [{ symbol: "WLD", token_amount: wei.toString() }],
            description: `Buy ${coinGain} COINS`
        });

        if (finalPayload.status === "success") {
            playerCOIN += coinGain;
            gameState.coin = playerCOIN;
            saveGame();

            document.getElementById('exchangeModal').remove();
            gameAlert("SUCCESS", `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${coinGain} COINS`);
        } else {
            gameAlert("FAILED", "‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    } catch (e) {
        console.error(e);
        gameAlert("ERROR", e.message);
    }
}

// ========================================================
// SELL : COINS ‚Üí WLD
// ========================================================
async function confirmSell() {
    const coin = parseInt(document.getElementById('sellCoin').value) || 0;
    if (coin < MIN_SELL_COIN) {
        gameAlert("ERROR", `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${MIN_SELL_COIN} COINS`);
        return;
    }
    if (coin > playerCOIN) {
        gameAlert("ERROR", "COINS ‡πÑ‡∏°‡πà‡∏û‡∏≠");
        return;
    }

    // *** ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ flow SELL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (server sign + sendTransaction) ***
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
    // playerCOIN -= coin;
    // gameState.coin = playerCOIN;
    // saveGame();
}
   </script>
</body>
</html>
